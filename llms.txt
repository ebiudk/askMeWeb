# AskMe! Web - VRChat Location Sharing Web Application

VRChatの居場所（インスタンス情報）を特定のグループ内で共有するためのWebアプリケーション。

## プロジェクト概要
- **目的**: プライバシーを保ちつつ、特定のグループ（フレンドなど）に限定してVRChatの居場所を共有する。
- **技術スタック**: Next.js 15 (App Router, Developed with Next.js 15.0.0-rc.0), Auth.js v5, Prisma, Tailwind CSS, PostgreSQL.
- **居場所取得**: 外部の居場所取得アプリ（作成済み）からAPI経由で `vrchat_id` をキーに位置情報を更新する。

## データモデル (Prisma Schema)
- `User`: VRChat ID (`vrchat_id`), 現在のワールドID (`current_world_id`), 表示名 (`display_name`), 最終更新日時.
- `Group`: グループ名, 一意の招待コード (`invite_code`).
- `Membership`: ユーザーとグループの多対多関係。ロール（`admin`, `member`）を保持。
- `Account`, `Session`, `VerificationToken`: Auth.js標準。

## 主要機能とフロー
### 1. 認証 (Auth.js)
- `src/auth.config.ts` と `src/auth.ts` で構成。
- Middlewareのサイズ制限（1MB）回避のため、Prismaを含まない設定を `auth.config.ts` に分離。
- セッション戦略は `jwt` を使用。
- パフォーマンス向上のため、サーバーサイドの `auth()` は React の `cache` でラップされている。

### 2. グループ管理
- **作成**: `POST /api/groups` で新規作成。作成者は `admin` ロール。招待コードは `nanoid` で自動生成。
- **参加**: `POST /api/groups/join` に招待コードを送信。または招待URL経由。
- **情報取得**:
  - `GET /api/groups`: 参加中のグループ一覧を取得。
  - `GET /api/groups/[id]`: グループ詳細とメンバーの居場所一覧を取得（メンバーのみ）。
  - `GET /api/groups/invite-info?code=...`: 招待コードからグループ名を確認。
- **表示**: `/` (ダッシュボード) で参加中一覧、`/groups/[id]` でメンバーの居場所一覧を表示。

### 3. 居場所共有
- **更新API**: `POST /api/update-location`
  - 外部の居場所取得アプリ（AskMe! Client）から `x-api-key` と共に `current_world_id`, `current_world_name`, `current_instance_id`, `display_name` を受信し、`UserLocation` を `upsert` する。
- **表示**: `/groups/[id]` ページで、そのグループに属するメンバーの `world_name`, `updated_at` などを表示。

### 4. ユーザー設定
- `/settings`: 自分の `vrchat_id` (usr_...) の設定や、APIキーの発行・再発行。

## 実装上の注意
- **Middleware**: Edge Runtimeの制限により、`middleware.ts` では `auth.config.ts` のみを使用し、Prisma（データベースアクセス）を避けること。
- **パフォーマンス最適化**:
  - `src/auth.ts` の `auth()` 関数は React の `cache` でラップされており、同一リクエスト内での重複呼び出しが最適化されている。
  - 重いデータ取得を伴うコンポーネントは `Suspense` とスケルトン表示を組み合わせてストリーミング表示を行う。
  - 非依存な非同期処理（`auth()` と `params` など）は `Promise.all` で並列化する。
- **型拡張**: `src/auth.ts` で `Session["user"]["id"]` を追加し、TypeScriptでユーザーIDにアクセス可能にしている。

## ディレクトリ構造 (主要部分)
- `src/app/api/`: APIエンドポイント（location更新、グループ操作）
- `src/app/groups/`: グループ関連のUI（詳細、参加）
- `src/app/settings/`: ユーザー設定UI
- `src/lib/prisma.ts`: Prisma Clientのシングルトン管理
- `src/auth.ts` / `src/auth.config.ts`: 認証設定
- `prisma/schema.prisma`: データベース定義
